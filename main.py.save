import json
import time
from datetime import datetime, timedelta
from strategies.strategy1 import run_strategy1
from strategies.strategy2 import run_strategy2
from strategies.strategy3 import run_strategy3
from sell_strategies.sell_strategy1 import sell_strategy1
from sell_strategies.sell_strategy2 import sell_strategy2
from sell_strategies.sell_strategy3 import evaluate_exit_strategy3
from utils.balance import load_holdings_from_file, get_holding_info
from utils.telegram import send_telegram
from utils.sheet import record_to_sheet
from utils.candle import get_all_krw_symbols, get_candles
from scanners.scanner2 import detect_strategy2_signals
from transition.strategy3_exit import handle_strategy3_exit
from scanners.scanner3 import detect_fast_rising_symbols




# ë´‡ ì‹¤í–‰ ì „ â†’ ë³´ìœ  ì¢…ëª© ìë™ ë³µêµ¬
load_holdings_from_file()

# ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
with open("config.json") as f:
    config = json.load(f)


# ì „ëµ ë§¤í•‘
strategy_map = {
    "strategy1": run_strategy1,
    "strategy2": run_strategy2,
    "strategy3": run_strategy3
}

# ë©”ì¸ ë£¨í”„
def run():
    fast_mode = False
    fast_mode_trigger_time = None

    while True:
        now = datetime.now()
        print(f"\n[{now.strftime('%Y-%m-%d %H:%M:%S')}] ğŸš€ Bot Running...")

        try:
            print("\nğŸ“ˆ [ì „ëµ1 ì‹¤í–‰ ì‹œì‘]")
            strategy1_result = strategy1(config)
            if strategy1_result:
                print(f"ğŸ¯ ì „ëµ1 ì§„ì… ì™„ë£Œ: {strategy1_result['ì¢…ëª©']}")
            else:
                print("â›” ì „ëµ1 ì§„ì… ì¡°ê±´ ë¯¸ì¶©ì¡±")

            print("ğŸ“¤ [ë§¤ë„ ì „ëµ1 ì‹¤í–‰]")
            sell_strategy1(config)

            # 30ì´ˆë§ˆë‹¤ ë°˜ë³µ
            time.sleep(30)

        except KeyboardInterrupt:
            print("â¹ï¸ í”„ë¡œê·¸ë¨ ìˆ˜ë™ ì¢…ë£Œë¨")
            break

        except Exception as e:
            print(f"âŒ ì˜ˆì™¸ ë°œìƒ: {e}")
            time.sleep(10)

        # ì „ëµ2 ê¸‰ë“± ê°ì§€
        config["watchlist"] = detect_strategy2_signals()
        if config["watchlist"]:
            print(f"âš¡ ì „ëµ2 ê¸‰ë“± ì¢…ëª©: {config['watchlist']}")

        # âœ… ì „ëµ ì‹¤í–‰ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰ (strategy1 â†’ strategy3 ìˆœì„œ ë³´ì¥)
        for strategy_name in config["strategies"]:
            print(f"ğŸš€ ì „ëµ ì‹¤í–‰ ì¤‘: {strategy_name}")
            strategy_func = strategy_map.get(strategy_name)
            if strategy_func:
                try:
                    result = strategy_func(config)
                    if result:
                        print(f"âœ… {strategy_name} ì‹¤í–‰ ê²°ê³¼: {result}")
                except Exception as e:
                    print(f"âŒ {strategy_name} ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜: {e}")

        # ì „ëµ2 ë§¤ë„ ì „ëµ ì‹¤í–‰
        try:
            candles_dict = {}
            for symbol in list(balance["holdings"].keys()):
               candles = get_candles(symbol, interval="1", count=50)  #ì‹¤ì œ ê¸°ì¡´ ìº”ë“¤
                if candles:
                    candles_dict[symbol] = candles

            sell_results = sell_strategy2(candles_dict, balance)

            for res in sell_results:
                print(f"ğŸ’¸ ì „ëµ2 ë§¤ë„ ì™„ë£Œ: {res['symbol']} / ê°€ê²©: {res['price']} / ìœ í˜•: {res['type']}")
        except Exception as e:
            print(f"âŒ ì „ëµ2 ë§¤ë„ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜: {e}")

        # ì „ëµ3 ê¸‰ë“± ê°ì§€ (fast mode íŠ¸ë¦¬ê±°ìš©)
        strategy3_signals = detect_fast_rising_symbols()
        if strategy3_signals:
            print(f"âš¡ ì „ëµ3 ê¸‰ë“± ê°ì§€ë¨: {strategy3_signals}")
            config["strategy3_signals"] = strategy3_signals
            fast_mode = True
            fast_mode_trigger_time = datetime.now()

        # ğŸ“¡ ê¸‰ë“± ëª¨ë“œ ìœ ì§€ ì‹œê°„ ì œì–´
        if fast_mode:
            elapsed = (datetime.now() - fast_mode_trigger_time).seconds
            if elapsed >= config.get("fast_mode_duration", 900):
                print("â± ê¸‰ë“± ëª¨ë“œ í•´ì œ â†’ ê¸°ë³¸ ê°„ê²© ë³µê·€")
                fast_mode = False

        # â³ ìŠ¤ìº” ê°„ê²© ì„¤ì •
        scan_interval = config["fast_scan_interval"] if fast_mode else config["scan_interval"]
        print(f"â³ ë‹¤ìŒ ìŠ¤ìº”ê¹Œì§€ ëŒ€ê¸°: {scan_interval}ì´ˆ\n")
        time.sleep(scan_interval)


if __name__ == "__main__":
    run()  # âœ… ì‹¤ì „ ë£¨í”„ ì‹¤í–‰



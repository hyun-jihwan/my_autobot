from utils.balance import get_holdings, get_current_price, update_balance_after_sell, remove_holding
from utils.candle import get_candles
from utils.risk import judge_trade_type
from datetime import datetime
from utils.transition_helper import evaluate_exit


def handle_strategy3_exit(config):
    print("ğŸ” ì „ëµ3 ì¢…ë£Œ ì¡°ê±´ í‰ê°€ ì‹œì‘")
    holdings = get_holdings()

    # ì „ëµ3 í¬ì§€ì…˜ì´ ì—†ë‹¤ë©´ â†’ ì „ëµ1 ìë™ ì „í™˜ ì‹œì‘
    if not holdings:
        print("ğŸ“­ ì „ëµ3 ë³´ìœ  ì—†ìŒ â†’ ì „ëµ1 ì „í™˜ í—ˆìš©")
        config["ready_for_strategy1"] = True
        return []

    released = []

    for h in holdings:
        if h.get("source") != "strategy3":
            continue  # ì „ëµ3 í¬ì§€ì…˜ë§Œ ì²˜ë¦¬

        symbol = h["symbol"]
        entry_time = h.get("entry_time", "N/A")
        quantity = h["quantity"]

        print(f"ğŸ“Œ ì „ëµ3 ì”ì—¬ ì¢…ëª© í™•ì¸: {symbol} / ì§„ì… ì‹œê°„: {entry_time}")

        # 1ì‹œê°„ë´‰ ê¸°ì¤€ ìŠ¤ìœ™ íŒë‹¨
        hourly_candles = get_candles(symbol, interval="60", count=10)
        is_swing = judge_trade_type(hourly_candles)
        trade_mode = "ìŠ¤ìœ™" if is_swing else "ë‹¨íƒ€"
        h["mode"] = trade_mode  # âœ… ëª¨ë“œ ê¸°ë¡

        # 15ë¶„ë´‰ ê¸°ì¤€ ë‹¨íƒ€ íŒë‹¨
        candles_15 = get_candles(symbol, interval="15", count=20)
        last = candles_15[0]
        body = abs(last["trade_price"] - last["opening_price"])
        high = last["high_price"]
        low = last["low_price"]
        body_ratio = body / (high - low) if (high - low) > 0 else 0

        if is_swing:
            print(f"âœ… ìŠ¤ìœ™ ì¡°ê±´ ì¶©ì¡± â†’ ìœ ì§€ ê²°ì •: {symbol}")
            # âœ… ì „ëµ3 â†’ ì „ëµ1ë¡œ ì†Œì† ì „í™˜
	    h["source"] = "strategy1"
	    print(f"ğŸ” ì „ëµ3 â†’ ì „ëµ1 ì „í™˜ ì™„ë£Œ: {symbol}")
            continue

        elif body_ratio > 0.5:
            print(f"âœ… ë‹¨íƒ€ ì¡°ê±´ ì¶©ì¡± (ê°•í•œ ìº”ë“¤) â†’ ìœ ì§€ ê²°ì •: {symbol}")
	    # âœ… ì „ëµ3 â†’ ì „ëµ1ë¡œ ì†Œì† ì „í™˜
	    h["source"] = "strategy1"
	    print(f"ğŸ” ì „ëµ3 â†’ ì „ëµ1 ì „í™˜ ì™„ë£Œ: {symbol}")
            continue

        else:
            result = evaluate_exit(symbol, quantity, source="strategy3")
            if not result:
                released.append(symbol)


    return released

import requests
import datetime

#def get_candles(symbol, interval="15", count=30)
def get_candles(symbol, interval="1", count=16): #í…ŒìŠ¤íŠ¸ìš©
    """
    ì—…ë¹„íŠ¸ ìº”ë“¤ ë°ì´í„° ì¡°íšŒ
    interval:
      - "1", "3", "5", "15", "30", "60", "240" â†’ ë¶„ë´‰
      - "day" â†’ ì¼ë´‰
      - "week" â†’ ì£¼ë´‰
      - "month" â†’ ì›”ë´‰
    """
    #í…ŒìŠ¤íŠ¸ ì‹œì‘
    if symbol == "KRW-A":
        return [
            {"opening_price": 100, "high_price": 102, "low_price": 99, "trade_price": 101, "candle_acc_trade_volume": 3000},
            {"opening_price": 101, "high_price": 102, "low_price": 100, "trade_price": 101, "candle_acc_trade_volume": 3100},
            {"opening_price": 101, "high_price": 103, "low_price": 100, "trade_price": 102, "candle_acc_trade_volume": 3200},
            {"opening_price": 102, "high_price": 103, "low_price": 101, "trade_price": 102, "candle_acc_trade_volume": 3300},
            {"opening_price": 102, "high_price": 103, "low_price": 101, "trade_price": 102, "candle_acc_trade_volume": 3400},
            {"opening_price": 102, "high_price": 103, "low_price": 101, "trade_price": 102, "candle_acc_trade_volume": 3500},
            {"opening_price": 102, "high_price": 103, "low_price": 101, "trade_price": 102, "candle_acc_trade_volume": 3600},
            {"opening_price": 102, "high_price": 104, "low_price": 101, "trade_price": 103, "candle_acc_trade_volume": 3700},
            {"opening_price": 103, "high_price": 104, "low_price": 102, "trade_price": 103, "candle_acc_trade_volume": 3800},
            {"opening_price": 103, "high_price": 104, "low_price": 102, "trade_price": 103, "candle_acc_trade_volume": 3900},
            {"opening_price": 103, "high_price": 104, "low_price": 102, "trade_price": 103, "candle_acc_trade_volume": 4000},
            {"opening_price": 103, "high_price": 104, "low_price": 102, "trade_price": 103, "candle_acc_trade_volume": 4100},
            {"opening_price": 103, "high_price": 104, "low_price": 102, "trade_price": 103, "candle_acc_trade_volume": 4200},
            {"opening_price": 103, "high_price": 104, "low_price": 102, "trade_price": 103, "candle_acc_trade_volume": 4300},
            {"opening_price": 103, "high_price": 105, "low_price": 102, "trade_price": 104, "candle_acc_trade_volume": 4400},
            {"opening_price": 107, "high_price": 108, "low_price": 106, "trade_price": 106, "candle_acc_trade_volume": 7000},
            {"opening_price": 108, "high_price": 110, "low_price": 108, "trade_price": 109, "candle_acc_trade_volume": 9000}
        ]

    if symbol == "KRW-B":
        print("ğŸ“Š KRW-B ìº”ë“¤ í˜¸ì¶œë¨")
        return [
            {"opening_price": 106, "high_price": 106, "low_price": 105, "trade_price": 105.0, "candle_acc_trade_volume": 3000},
            {"opening_price": 105, "high_price": 106, "low_price": 104, "trade_price": 105.0, "candle_acc_trade_volume": 2800},
            {"opening_price": 105, "high_price": 106, "low_price": 104, "trade_price": 105.0, "candle_acc_trade_volume": 2700},
            {"opening_price": 105, "high_price": 106, "low_price": 104, "trade_price": 105.0, "candle_acc_trade_volume": 2600},
            {"opening_price": 105, "high_price": 106, "low_price": 104, "trade_price": 105.0, "candle_acc_trade_volume": 2500}
        ]

    if symbol == "KRW-C":
        print("ğŸ“Š KRW-C ìº”ë“¤ í˜¸ì¶œë¨")
        return [
            {"opening_price": 108, "high_price": 109, "low_price": 107, "trade_price": 108.5, "candle_acc_trade_volume": 5000},
            {"opening_price": 108, "high_price": 109, "low_price": 107, "trade_price": 108.4, "candle_acc_trade_volume": 4800},
            {"opening_price": 108, "high_price": 108, "low_price": 106, "trade_price": 107.8, "candle_acc_trade_volume": 4600},
            {"opening_price": 107.5, "high_price": 108, "low_price": 106.5, "trade_price": 107.2, "candle_acc_trade_volume": 4400},
            {"opening_price": 107.0, "high_price": 107.5, "low_price": 106.0, "trade_price": 106.5, "candle_acc_trade_volume": 4200},
            {"opening_price": 106.5, "high_price": 107.0, "low_price": 105.5, "trade_price": 106.0, "candle_acc_trade_volume": 4100},
            {"opening_price": 106.0, "high_price": 106.5, "low_price": 105.0, "trade_price": 105.5, "candle_acc_trade_volume": 4000},
            {"opening_price": 105.5, "high_price": 106.0, "low_price": 104.5, "trade_price": 105.0, "candle_acc_trade_volume": 3900},
            {"opening_price": 105.0, "high_price": 105.5, "low_price": 104.0, "trade_price": 104.5, "candle_acc_trade_volume": 3800},
            {"opening_price": 104.5, "high_price": 105.0, "low_price": 103.5, "trade_price": 104.0, "candle_acc_trade_volume": 3700},
            {"opening_price": 104.0, "high_price": 104.5, "low_price": 103.0, "trade_price": 103.5, "candle_acc_trade_volume": 3600},
            {"opening_price": 103.5, "high_price": 104.0, "low_price": 102.5, "trade_price": 103.0, "candle_acc_trade_volume": 3500},
            {"opening_price": 103.0, "high_price": 103.5, "low_price": 102.0, "trade_price": 102.5, "candle_acc_trade_volume": 3400},
            {"opening_price": 102.5, "high_price": 103.0, "low_price": 101.5, "trade_price": 102.0, "candle_acc_trade_volume": 3300},
            {"opening_price": 102.0, "high_price": 102.5, "low_price": 101.0, "trade_price": 101.5, "candle_acc_trade_volume": 3200},
            {"opening_price": 101.5, "high_price": 102.0, "low_price": 100.5, "trade_price": 101.0, "candle_acc_trade_volume": 3100}
        ]

    print(f"âŒ {symbol} â†’ ìº”ë“¤ ì‘ë‹µ ì‹¤íŒ¨ / ìƒíƒœì½”ë“œ: 404")
    return []
    #í…ŒìŠ¤íŠ¸ ë

    if interval == "day":
        url = "https://api.upbit.com/v1/candles/days"
    elif interval == "week":
        url = "https://api.upbit.com/v1/candles/weeks"
    elif interval == "month":
        url = "https://api.upbit.com/v1/candles/months"
    else:
        url = f"https://api.upbit.com/v1/candles/minutes/{interval}"

    params = {"market": symbol, "count": count}
    headers = {"accept": "application/json"}

    try:
        response = requests.get(url, params=params, headers=headers)
        if response.status_code == 200:
            return response.json()
        else:
            print(f"âŒ {symbol} â†’ ìº”ë“¤ ì‘ë‹µ ì‹¤íŒ¨ / ìƒíƒœì½”ë“œ: {response.status_code}")
            return []
    except Exception as e:
        print(f"âŒ {symbol} â†’ ìš”ì²­ ì¤‘ ì˜ˆì™¸ ë°œìƒ: {e}")
        return []

def is_box_breakout(candles):
    """
    ë°•ìŠ¤ê¶Œ ìƒë‹¨ ì¬ëŒíŒŒ íŒ¨í„´ íŒë³„
    - ìµœê·¼ 5~10ë´‰ ë™ì•ˆ ê°€ê²© ë³€ë™í­ì´ Â±1% ì´ë‚´
    - ì´í›„ ì–‘ë´‰ ëŒíŒŒ + ê±°ë˜ëŸ‰ 1.5ë°° ì´ìƒ
    """
    if len(candles) < 12:
        return False

    recent = candles[2:12]  # ë°•ìŠ¤ ë¶„ì„ìš© êµ¬ê°„
    prices = [c["trade_price"] for c in recent]
    max_price = max(prices)
    min_price = min(prices)

    box_range = (max_price - min_price) / min_price
    if box_range > 0.01:  # ë°•ìŠ¤í­ Â±1% ì´ìƒì´ë©´ ë°•ìŠ¤ ì•„ë‹˜
        return False

    current = candles[0]
    prev = candles[1]

    # ì–‘ë´‰ ëŒíŒŒ + ê±°ë˜ëŸ‰ 1.5ë°° ì´ìƒ
    if current["trade_price"] > max_price and current["opening_price"] < current["trade_price"]:
        if current["candle_acc_trade_volume"] > prev["candle_acc_trade_volume"] * 1.5:
            return True

    return False

def is_breakout_pullback(candles):
    """
    ëŒíŒŒ í›„ ëˆŒë¦¼ íŒ¨í„´ ê°ì§€
    - ê³ ì  ëŒíŒŒ í›„ ëˆŒë¦¼
    - ìµœê·¼ ë´‰ ì–‘ë´‰
    - ê±°ë˜ëŸ‰ ì „ë´‰ë³´ë‹¤ 1.2ë°° ì´ìƒ
    """
    if len(candles) < 6:
        return False

    prev_5 = candles[1:6]
    high = max(c["high_price"] for c in prev_5)
    low = min(c["low_price"] for c in prev_5)

    # í˜„ì¬ë´‰ ì¡°ê±´
    current = candles[0]
    prev = candles[1]

    # ëˆŒë¦¼ í›„ ì–‘ë´‰ + ê±°ë˜ëŸ‰ ì¦ê°€
    if current["trade_price"] > low and current["opening_price"] < current["trade_price"]:
        if current["candle_acc_trade_volume"] > prev["candle_acc_trade_volume"] * 1.2:
            return True
    return False

def is_v_rebound(candles):
    """
    Vì ë°˜ë“± íŒ¨í„´ ê°ì§€
    - í° ìŒë´‰ â†’ í° ì–‘ë´‰ (ë°˜ì „)
    - ì–‘ë´‰ ê±°ë˜ëŸ‰ì´ ìŒë´‰ë³´ë‹¤ 1.2ë°° ì´ìƒ
    """
    if len(candles) < 3:
        return False

    down = candles[2]
    up = candles[1]
    now = candles[0]

    # down = ê¸´ ìŒë´‰, up = ê¸´ ì–‘ë´‰
    down_range = down["opening_price"] - down["trade_price"]
    up_range = up["trade_price"] - up["opening_price"]

    if down_range <= 0 or up_range <= 0:
        return False

    if up_range < down_range * 0.8:
        return False  # ì–‘ë´‰ì´ ì¶©ë¶„íˆ í¬ì§€ ì•ŠìŒ

    # ê±°ë˜ëŸ‰ ì¡°ê±´
    if up["candle_acc_trade_volume"] < down["candle_acc_trade_volume"] * 1.2:
        return False

    # í˜„ì¬ë´‰ì´ ì–‘ë´‰ ìœ ì§€ ì¤‘ì´ë©´ Vì ë°˜ë“± í™•ì •
    if now["trade_price"] > now["opening_price"]:
        return True

    return False

def get_all_krw_symbols():
    url = "https://api.upbit.com/v1/market/all"
    try:
        response = requests.get(url)
        if response.status_code == 200:
            data = response.json()
            return [item['market'] for item in data if item['market'].startswith("KRW-")]
        else:
            print("âŒ ì‹¬ë³¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨")
            return []
    except Exception as e:
        print(f"âŒ ì‹¬ë³¼ ìš”ì²­ ì¤‘ ì˜¤ë¥˜: {e}")
        return []

#í…ŒìŠ¤íŠ¸ ì‹œì‘
def save_test_candles(symbol, candles, filepath="data/test_candles.json"):
    import json
    import os
    os.makedirs(os.path.dirname(filepath), exist_ok=True)
    
    all_data = {}
    if os.path.exists(filepath):
        with open(filepath, "r", encoding="utf-8") as f:
            try:
                all_data = json.load(f)
            except:
                all_data = {}

    all_data[symbol] = candles
    with open(filepath, "w", encoding="utf-8") as f:
        json.dump(all_data, f, indent=2, ensure_ascii=False)

    print(f"ğŸ•¯ í…ŒìŠ¤íŠ¸ ìº”ë“¤ ì €ì¥ ì™„ë£Œ â†’ {symbol}")
#í…ŒìŠ¤íŠ¸ ë
